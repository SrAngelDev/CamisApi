# nginx.conf
events {}

http {
    # Formato de log JSON
    log_format main_json escape=json
        '{'
          '"remote_addr": "$remote_addr",'
          '"time_local": "$time_local",'
          '"request_method": "$request_method",'
          '"request_uri": "$request_uri",'
          '"status": "$status",'
          '"body_bytes_sent": "$body_bytes_sent",'
          '"http_referer": "$http_referer",'
          '"http_user_agent": "$http_user_agent",'
          '"upstream_addr": "$upstream_addr",'
          '"upstream_status": "$upstream_status",'
          '"upstream_response_time": "$upstream_response_time"'
        '}';

    upstream api_backend {
        # 1. Le decimos a NGINX que use el DNS interno de Docker
        resolver 127.0.0.11 valid=5s;

        # 2. Apuntamos al *nombre del servicio* ('api') del docker-compose.
        # NGINX consultar치 al resolver y obtendr치 las IPs de TODAS
        # las r칠plicas (ej. 172.20.0.5, 172.20.0.6, 172.20.0.7)
        # y balancear치 la carga entre ellas.
        server api:8080;
    }

    server {
        listen 80;

        access_log /var/log/nginx/access.log main_json;
        error_log /var/log/nginx/error.log;

        # --- Las reglas de enrutamiento ---

        # API principal
        location /api/ {
            proxy_pass http://api_backend; 
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # GraphQL
        location /graphql {
            proxy_pass http://api_backend/graphql;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # GraphiQL - interfaz web
        location /graphiql {
            proxy_pass http://api_backend/graphiql;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_http_version 1.1;
        }

        # Autenticaci칩n
        location /auth/ {
            proxy_pass http://api_backend;
            proxy_set_header Host $host;
        }

        # Swagger/OpenAPI - manejo completo de todas las rutas
        location /swagger-ui {
            proxy_pass http://api_backend/swagger-ui;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /v3/api-docs {
            proxy_pass http://api_backend/v3/api-docs;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Recursos est치ticos de Swagger
        location /swagger-resources {
            proxy_pass http://api_backend/swagger-resources;
            proxy_set_header Host $host;
        }

        location /webjars/ {
            proxy_pass http://api_backend/webjars/;
            proxy_set_header Host $host;
        }

        # Reportes de test
        location /test/ {
            proxy_pass http://test-server/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location = /test {
            return 301 /test/;
        }

        # Documentaci칩n Dokka
        location /doc/ {
            proxy_pass http://doc-server/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location = /doc {
            return 301 /doc/;
        }

        # Cobertura de c칩digo
        location /coverage/ {
            proxy_pass http://coverage-server/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location = /coverage {
            return 301 /coverage/;
        }

        # P치gina de inicio o dashboard
        location / {
            return 200 '<!DOCTYPE html>
                            <html>
                            <head lang="es">
                                <meta charset="UTF-8">
                                <title>CamisAPI - Dashboard</title>
                                <style>
                                    body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
                                    .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                                    h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
                                    .links { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
                                    a { display: block; padding: 15px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; text-align: center; transition: background 0.3s; }
                                    a:hover { background: #0056b3; }
                                    .section { margin-top: 30px; }
                                    .section h2 { color: #666; font-size: 18px; margin-bottom: 10px; }
                                </style>
                            </head>
                            <body>
                                <div class="container">
                                    <h1>游 CamisAPI Dashboard</h1>
                                    
                                    <div class="section">
                                        <h2>游늵 Reportes y Documentaci칩n</h2>
                                        <div class="links">
                                            <a href="/test/" target="_blank">游닇 Reporte de Test</a>
                                            <a href="/doc/" target="_blank">游닄 Documentacion de la API</a>
                                            <a href="/coverage/" target="_blank">游늳 Cobertura de C칩digo</a>
                                        </div>
                                    </div>

                                </div>
                            </body>
                            </html>';
            add_header Content-Type text/html;
        }
    }
}