# nginx.conf
events {}

http {
    # Formato de log JSON
    log_format main_json escape=json
        '{'
          '"remote_addr": "$remote_addr",'
          '"time_local": "$time_local",'
          '"request_method": "$request_method",'
          '"request_uri": "$request_uri",'
          '"status": "$status",'
          '"body_bytes_sent": "$body_bytes_sent",'
          '"http_referer": "$http_referer",'
          '"http_user_agent": "$http_user_agent",'
          '"upstream_addr": "$upstream_addr",'
          '"upstream_status": "$upstream_status",'
          '"upstream_response_time": "$upstream_response_time"'
        '}';

    upstream api_backend {
        # 1. Le decimos a NGINX que use el DNS interno de Docker
        resolver 127.0.0.11 valid=5s;

        # 2. Apuntamos al *nombre del servicio* ('api') del docker-compose.
        # NGINX consultará al resolver y obtendrá las IPs de TODAS
        # las réplicas (ej. 172.20.0.5, 172.20.0.6, 172.20.0.7)
        # y balanceará la carga entre ellas.
        server api:8080;
    }

    server {
        listen 80;

        access_log /var/log/nginx/access.log main_json;
        error_log /var/log/nginx/error.log;

        # --- Las reglas de enrutamiento ---

        location /api/ {
            proxy_pass http://api_backend/; 
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /test/ {
            proxy_pass http://test-server/;
        }

        location /doc/ {
            proxy_pass http://doc-server/;
        }

        location /coverage/ {
            proxy_pass http://coverage-server/;
        }
    }
}